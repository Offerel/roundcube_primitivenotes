!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):(global=global||self).Tagify=factory()}(this,(function(){"use strict";function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_nonIterableSpread()}function _arrayWithoutHoles(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}}function _iterableToArray(iter){if(Symbol.iterator in Object(iter)||"[object Arguments]"===Object.prototype.toString.call(iter))return Array.from(iter)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var sameStr=function sameStr(s1,s2,caseSensitive,trim){return s1=""+s1,s2=""+s2,trim&&(s1=s1.trim(),s2=s2.trim()),caseSensitive?s1==s2:s1.toLowerCase()==s2.toLowerCase()},removeCollectionProp=function removeCollectionProp(collection,unwantedProps){return collection.map((function(v){var props={};for(var p in v)unwantedProps.indexOf(p)<0&&(props[p]=v[p]);return props}))};function decode(s){var el=document.createElement("div");return s.replace(/\&#?[0-9a-z]+;/gi,(function(enc){return el.innerHTML=enc,el.innerText}))}function parseHTML(s){var parser,node;return(new DOMParser).parseFromString(s.trim(),"text/html").body.firstElementChild}function minify(s){return s?s.replace(/\>[\r\n ]+\</g,"><").replace(/(<.*?>)|\s+/g,(function(m,$1){return $1||" "})):""}function removeTextChildNodes(elm){for(var iter=document.createNodeIterator(elm,NodeFilter.SHOW_TEXT,null,!1),textnode;textnode=iter.nextNode();)textnode.textContent.trim()||textnode.parentNode.removeChild(textnode)}function getfirstTextNode(elm,action){for(action=action||"previous";elm=elm[action+"Sibling"];)if(3==elm.nodeType)return elm}function escapeHTML(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/`|'/g,"&#039;")}function isArray(a){return a instanceof Array}function isObject(obj){var type=Object.prototype.toString.call(obj).split(" ")[1].slice(0,-1);return obj===Object(obj)&&"Array"!=type&&"Function"!=type&&"RegExp"!=type&&"HTMLUnknownElement"!=type}function extend(o,o1,o2){function copy(a,b){for(var key in b)if(b.hasOwnProperty(key)){if(isObject(b[key])){isObject(a[key])?copy(a[key],b[key]):a[key]=Object.assign({},b[key]);continue}if(isArray(b[key])){a[key]=Object.assign([],b[key]);continue}a[key]=b[key]}}return o instanceof Object||(o={}),copy(o,o1),o2&&copy(o,o2),o}function unaccent(s){return String.prototype.normalize?"string"==typeof s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,""):void 0:s}function getNodeHeight(node){var height,clone=node.cloneNode(!0);return clone.style.cssText="position:fixed; top:-9999px; opacity:0",document.body.appendChild(clone),height=clone.clientHeight,clone.parentNode.removeChild(clone),height}var isChromeAndroidBrowser=/(?=.*chrome)(?=.*android)/i.test(navigator.userAgent),dropdownMethods={init:function init(){this.DOM.dropdown=this.parseTemplate("dropdown",[this.settings]),this.DOM.dropdown.content=this.DOM.dropdown.querySelector(this.settings.classNames.dropdownWrapperSelector)},show:function show(value){var _this=this,_s=this.settings,firstListItem,firstListItemValue,selection=window.getSelection(),allowNewTags="mix"==_s.mode&&!_s.enforceWhitelist,noWhitelist=!_s.whitelist||!_s.whitelist.length,noMatchListItem,isManual="manual"==_s.dropdown.position;if(value=void 0===value?this.state.inputText:value,(!noWhitelist||allowNewTags||_s.templates.dropdownItemNoMatch)&&!1!==_s.dropdown.enable&&!this.state.isLoading){if(clearTimeout(this.dropdownHide__bindEventsTimeout),this.suggestedListItems=this.dropdown.filterListItems.call(this,value),value&&!this.suggestedListItems.length&&(this.trigger("dropdown:noMatch",value),_s.templates.dropdownItemNoMatch&&(noMatchListItem=_s.templates.dropdownItemNoMatch.call(this,{value:value}))),!noMatchListItem){if(this.suggestedListItems.length)value&&allowNewTags&&!this.state.editing.scope&&!sameStr(this.suggestedListItems[0].value,value)&&this.suggestedListItems.unshift({value:value});else{if(!value||!allowNewTags||this.state.editing.scope)return this.input.autocomplete.suggest.call(this),void this.dropdown.hide.call(this);this.suggestedListItems=[{value:value}]}firstListItemValue=""+(isObject(firstListItem=this.suggestedListItems[0])?firstListItem.value:firstListItem),_s.autoComplete&&firstListItemValue&&0==firstListItemValue.indexOf(value)&&this.input.autocomplete.suggest.call(this,firstListItem)}this.dropdown.fill.call(this,noMatchListItem),_s.dropdown.highlightFirst&&this.dropdown.highlightOption.call(this,this.DOM.dropdown.content.children[0]),this.state.dropdown.visible||setTimeout(this.dropdown.events.binding.bind(this)),this.state.dropdown.visible=value||!0,this.state.dropdown.query=value,this.state.selection={anchorOffset:selection.anchorOffset,anchorNode:selection.anchorNode},isManual||setTimeout((function(){_this.dropdown.position.call(_this),_this.dropdown.render.call(_this)})),setTimeout((function(){_this.trigger("dropdown:show",_this.DOM.dropdown)}))}},hide:function hide(force){var _this2=this,_this$DOM=this.DOM,scope=_this$DOM.scope,dropdown=_this$DOM.dropdown,isManual="manual"==this.settings.dropdown.position&&!force;if(dropdown&&document.body.contains(dropdown)&&!isManual)return window.removeEventListener("resize",this.dropdown.position),this.dropdown.events.binding.call(this,!1),scope.setAttribute("aria-expanded",!1),dropdown.parentNode.removeChild(dropdown),setTimeout((function(){_this2.state.dropdown.visible=!1}),100),this.state.dropdown.query=this.state.ddItemData=this.state.ddItemElm=this.state.selection=null,this.state.tag&&this.state.tag.value.length&&(this.state.flaggedTags[this.state.tag.baseOffset]=this.state.tag),this.trigger("dropdown:hide",dropdown),this},render:function render(){var _this3=this,ddHeight=getNodeHeight(this.DOM.dropdown),_s=this.settings;return this.DOM.scope.setAttribute("aria-expanded",!0),document.body.contains(this.DOM.dropdown)||(this.DOM.dropdown.classList.add(_s.classNames.dropdownInital),this.dropdown.position.call(this,ddHeight),_s.dropdown.appendTarget.appendChild(this.DOM.dropdown),setTimeout((function(){return _this3.DOM.dropdown.classList.remove(_s.classNames.dropdownInital)}))),this},fill:function fill(HTMLContent){HTMLContent="string"==typeof HTMLContent?HTMLContent:this.dropdown.createListHTML.call(this,HTMLContent||this.suggestedListItems),this.DOM.dropdown.content.innerHTML=minify(HTMLContent)},refilter:function refilter(value){value=value||this.state.dropdown.query||"",this.suggestedListItems=this.dropdown.filterListItems.call(this,value),this.dropdown.fill.call(this),this.suggestedListItems.length||this.dropdown.hide.call(this),this.trigger("dropdown:updated",this.DOM.dropdown)},position:function position(ddHeight){if("manual"!=this.settings.dropdown.position){var placeAbove,rect,top,bottom,left,width,parentsPositions,ddElm=this.DOM.dropdown,viewportHeight=document.documentElement.clientHeight,viewportWidth,positionTo=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0)>480?this.settings.dropdown.position:"all",ddTarget=this.DOM["input"==positionTo?"input":"scope"];ddHeight=ddHeight||ddElm.clientHeight,this.state.dropdown.visible&&("text"==positionTo?(bottom=(rect=this.getCaretGlobalPosition()).bottom,top=rect.top,left=rect.left,width="auto"):(parentsPositions=getParentsPositions(this.settings.dropdown.appendTarget),top=(rect=ddTarget.getBoundingClientRect()).top+2-parentsPositions.top,bottom=rect.bottom-1-parentsPositions.top,left=rect.left-parentsPositions.left,width=rect.width+"px"),top=Math.floor(top),bottom=Math.ceil(bottom),placeAbove=viewportHeight-rect.bottom<ddHeight,ddElm.style.cssText="left:"+(left+window.pageXOffset)+"px; width:"+width+";"+(placeAbove?"top: "+(top+window.pageYOffset)+"px":"top: "+(bottom+window.pageYOffset)+"px"),ddElm.setAttribute("placement",placeAbove?"top":"bottom"),ddElm.setAttribute("position",positionTo))}function getParentsPositions(p){for(var left=0,top=0;p;)left+=p.offsetLeft||0,top+=p.offsetTop||0,p=p.parentNode;return{left:left,top:top}}},events:{binding:function binding(){var bindUnbind=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],_CB=this.dropdown.events.callbacks,_CBR=this.listeners.dropdown=this.listeners.dropdown||{position:this.dropdown.position.bind(this),onKeyDown:_CB.onKeyDown.bind(this),onMouseOver:_CB.onMouseOver.bind(this),onMouseLeave:_CB.onMouseLeave.bind(this),onClick:_CB.onClick.bind(this),onScroll:_CB.onScroll.bind(this)},action=bindUnbind?"addEventListener":"removeEventListener";"manual"!=this.settings.dropdown.position&&(window[action]("resize",_CBR.position),window[action]("keydown",_CBR.onKeyDown)),this.DOM.dropdown[action]("mouseover",_CBR.onMouseOver),this.DOM.dropdown[action]("mouseleave",_CBR.onMouseLeave),this.DOM.dropdown[action]("mousedown",_CBR.onClick),this.DOM.dropdown.content[action]("scroll",_CBR.onScroll)},callbacks:{onKeyDown:function onKeyDown(e){var activeListElm=this.DOM.dropdown.querySelector(this.settings.classNames.dropdownItemActiveSelector),selectedElm=activeListElm;switch(e.key){case"ArrowDown":case"ArrowUp":case"Down":case"Up":var dropdownItems;e.preventDefault(),selectedElm&&(selectedElm=selectedElm[("ArrowUp"==e.key||"Up"==e.key?"previous":"next")+"ElementSibling"]),selectedElm||(selectedElm=(dropdownItems=this.DOM.dropdown.content.children)["ArrowUp"==e.key||"Up"==e.key?dropdownItems.length-1:0]),this.dropdown.highlightOption.call(this,selectedElm,!0);break;case"Escape":case"Esc":this.dropdown.hide.call(this);break;case"ArrowRight":if(this.state.actions.ArrowLeft)return;case"Tab":if("mix"!=this.settings.mode&&selectedElm&&!this.settings.autoComplete.rightKey&&!this.state.editing){e.preventDefault();var tagifySuggestionIdx=selectedElm.getAttribute("tagifySuggestionIdx"),data=tagifySuggestionIdx?this.suggestedListItems[+tagifySuggestionIdx]:"",value=this.dropdown.getMappedValue.call(this,data);return this.input.autocomplete.set.call(this,value),!1}return!0;case"Enter":e.preventDefault(),this.dropdown.selectOption.call(this,activeListElm);break;case"Backspace":if("mix"==this.settings.mode||this.state.editing.scope)return;var _value=this.state.inputText.trim();""!=_value&&8203!=_value.charCodeAt(0)||(!0===this.settings.backspace?this.removeTags():"edit"==this.settings.backspace&&setTimeout(this.editTag.bind(this),0))}},onMouseOver:function onMouseOver(e){var ddItem=e.target.closest(this.settings.classNames.dropdownItemSelector);ddItem&&this.dropdown.highlightOption.call(this,ddItem)},onMouseLeave:function onMouseLeave(e){this.dropdown.highlightOption.call(this)},onClick:function onClick(e){var _this4=this;if(0==e.button&&e.target!=this.DOM.dropdown&&e.target!=this.DOM.dropdown.content){var listItemElm=e.target.closest(this.settings.classNames.dropdownItemSelector);this.state.actions.selectOption=!0,setTimeout((function(){return _this4.state.actions.selectOption=!1}),50),this.settings.hooks.suggestionClick(e,{tagify:this,suggestionElm:listItemElm}).then((function(){listItemElm?_this4.dropdown.selectOption.call(_this4,listItemElm):_this4.dropdown.hide.call(_this4)})).catch((function(err){return err}))}},onScroll:function onScroll(e){var elm=e.target,pos=elm.scrollTop/(elm.scrollHeight-elm.parentNode.clientHeight)*100;this.trigger("dropdown:scroll",{percentage:Math.round(pos)})}}},highlightOption:function highlightOption(elm,adjustScroll){var className=this.settings.classNames.dropdownItemActive,itemData;if(this.state.ddItemElm&&(this.state.ddItemElm.classList.remove(className),this.state.ddItemElm.removeAttribute("aria-selected")),!elm)return this.state.ddItemData=null,this.state.ddItemElm=null,void this.input.autocomplete.suggest.call(this);itemData=this.suggestedListItems[this.getNodeIndex(elm)],this.state.ddItemData=itemData,this.state.ddItemElm=elm,elm.classList.add(className),elm.setAttribute("aria-selected",!0),adjustScroll&&(elm.parentNode.scrollTop=elm.clientHeight+elm.offsetTop-elm.parentNode.clientHeight),this.settings.autoComplete&&(this.input.autocomplete.suggest.call(this,itemData),this.dropdown.position.call(this))},selectOption:function selectOption(elm){var _this5=this,_this$settings$dropdo=this.settings.dropdown,clearOnSelect=_this$settings$dropdo.clearOnSelect,closeOnSelect=_this$settings$dropdo.closeOnSelect;if(!elm)return this.addTags(this.state.inputText,!0),void(closeOnSelect&&this.dropdown.hide.call(this));var tagifySuggestionIdx=elm.getAttribute("tagifySuggestionIdx"),tagData=this.suggestedListItems[+tagifySuggestionIdx];if(this.trigger("dropdown:select",{data:tagData,elm:elm}),tagifySuggestionIdx&&tagData){if(this.state.editing?this.onEditTagDone(null,extend({__isValid:!0},tagData)):this["mix"==this.settings.mode?"addMixTags":"addTags"]([tagData],clearOnSelect),setTimeout((function(){_this5.DOM.input.focus(),_this5.toggleFocusClass(!0)})),closeOnSelect)return this.dropdown.hide.call(this);this.dropdown.refilter.call(this)}else this.dropdown.hide.call(this)},selectAll:function selectAll(){return this.suggestedListItems.length=0,this.dropdown.hide.call(this),this.addTags(this.dropdown.filterListItems.call(this,""),!0),this},filterListItems:function filterListItems(value,options){var _this6=this,_s=this.settings,_sd=_s.dropdown,options=options||{},list=[],whitelist=_s.whitelist,suggestionsCount=_sd.maxItems||1/0,searchKeys=_sd.searchKeys,whitelistItem,valueIsInWhitelist,searchBy,isDuplicate,niddle,i=0;if(!value||!searchKeys.length)return(_s.duplicates?whitelist:whitelist.filter((function(item){return!_this6.isTagDuplicate(isObject(item)?item.value:item)}))).slice(0,suggestionsCount);function stringHasAll(s,query){return query.toLowerCase().split(" ").every((function(q){return s.includes(q.toLowerCase())}))}for(niddle=_sd.caseSensitive?""+value:(""+value).toLowerCase();i<whitelist.length;i++){whitelistItem=whitelist[i]instanceof Object?whitelist[i]:{value:whitelist[i]};var itemWithoutSearchKeys,_searchKeys=!Object.keys(whitelistItem).some((function(k){return searchKeys.includes(k)}))?["value"]:searchKeys;if(_sd.fuzzySearch&&!options.exact?(searchBy=_searchKeys.reduce((function(values,k){return values+" "+(whitelistItem[k]||"")}),"").toLowerCase(),_sd.accentedSearch&&(searchBy=unaccent(searchBy),niddle=unaccent(niddle)),valueIsInWhitelist=stringHasAll(searchBy,niddle)):valueIsInWhitelist=_searchKeys.some((function(k){var v=""+(whitelistItem[k]||"");return _sd.accentedSearch&&(v=unaccent(v),niddle=unaccent(niddle)),_sd.caseSensitive||(v=v.toLowerCase()),options.exact?v==niddle:0==v.indexOf(niddle)})),isDuplicate=!_s.duplicates&&this.isTagDuplicate(isObject(whitelistItem)?whitelistItem.value:whitelistItem),valueIsInWhitelist&&!isDuplicate&&suggestionsCount--&&list.push(whitelistItem),0==suggestionsCount)break}return list},getMappedValue:function getMappedValue(tagData){var mapValueTo=this.settings.dropdown.mapValueTo,value;return mapValueTo?"function"==typeof mapValueTo?mapValueTo(tagData):tagData[mapValueTo]||tagData.value:tagData.value},createListHTML:function createListHTML(optionsArr){var _this7=this;return extend([],optionsArr).map((function(suggestion,idx){"string"!=typeof suggestion&&"number"!=typeof suggestion||(suggestion={value:suggestion});var value=_this7.dropdown.getMappedValue.call(_this7,suggestion);suggestion.value=value&&"string"==typeof value?escapeHTML(value):value;var tagHTMLString=_this7.settings.templates.dropdownItem.call(_this7,suggestion);return tagHTMLString=tagHTMLString.replace(/\s*tagifySuggestionIdx=(["'])(.*?)\1/gim,"").replace(">",' tagifySuggestionIdx="'.concat(idx,'">'))})).join("")}},DEFAULTS={delimiters:",",pattern:null,tagTextProp:"value",maxTags:1/0,callbacks:{},addTagOnBlur:!0,duplicates:!1,whitelist:[],blacklist:[],enforceWhitelist:!1,keepInvalidTags:!1,mixTagsAllowedAfter:/,|\.|\:|\s/,mixTagsInterpolator:["[[","]]"],backspace:!0,skipInvalid:!1,editTags:{clicks:2,keepInvalid:!0},transformTag:function transformTag(){},trim:!0,mixMode:{insertAfterTag:" "},autoComplete:{enabled:!0,rightKey:!1},classNames:{namespace:"tagify",mixMode:"tagify--mix",selectMode:"tagify--select",input:"tagify__input",focus:"tagify--focus",tag:"tagify__tag",tagNoAnimation:"tagify--noAnim",tagInvalid:"tagify--invalid",tagNotAllowed:"tagify--notAllowed",inputInvalid:"tagify__input--invalid",tagX:"tagify__tag__removeBtn",tagText:"tagify__tag-text",dropdown:"tagify__dropdown",dropdownWrapper:"tagify__dropdown__wrapper",dropdownItem:"tagify__dropdown__item",dropdownItemActive:"tagify__dropdown__item--active",dropdownInital:"tagify__dropdown--initial",scopeLoading:"tagify--loading",tagLoading:"tagify__tag--loading",tagEditing:"tagify__tag--editable",tagFlash:"tagify__tag--flash",tagHide:"tagify__tag--hide",hasMaxTags:"tagify--hasMaxTags",hasNoTags:"tagify--noTags",empty:"tagify--empty"},dropdown:{classname:"",enabled:2,maxItems:10,searchKeys:["value","searchBy"],fuzzySearch:!0,caseSensitive:!1,accentedSearch:!0,highlightFirst:!1,closeOnSelect:!0,clearOnSelect:!0,position:"all",appendTarget:null},hooks:{beforeRemoveTag:function beforeRemoveTag(){return Promise.resolve()},suggestionClick:function suggestionClick(){return Promise.resolve()}}},templates={wrapper:function wrapper(input,_s){return'<tags class="'.concat(_s.classNames.namespace," ").concat(_s.mode?"".concat(_s.classNames[_s.mode+"Mode"]):""," ").concat(input.className,'"\n                    ').concat(_s.readonly?"readonly":"","\n                    ").concat(_s.required?"required":"",'\n                    tabIndex="-1">\n            <span ').concat(_s.readonly&&"mix"==_s.mode?"":"contenteditable",' data-placeholder="').concat(_s.placeholder||"&#8203;",'" aria-placeholder="').concat(_s.placeholder||"",'"\n                class="').concat(_s.classNames.input,'"\n                role="textbox"\n                aria-autocomplete="both"\n                aria-multiline="').concat("mix"==_s.mode,'"></span>\n        </tags>')},tag:function tag(tagData){return'<tag title="'.concat(tagData.title||tagData.value,"\"\n                    contenteditable='false'\n                    spellcheck='false'\n                    tabIndex=\"-1\"\n                    class=\"").concat(this.settings.classNames.tag," ").concat(tagData.class?tagData.class:"",'"\n                    ').concat(this.getAttributes(tagData),">\n            <x title='' class=\"").concat(this.settings.classNames.tagX,"\" role='button' aria-label='remove tag'></x>\n            <div>\n                <span class=\"").concat(this.settings.classNames.tagText,'">').concat(tagData[this.settings.tagTextProp]||tagData.value,"</span>\n            </div>\n        </tag>")},dropdown:function dropdown(settings){var _sd=settings.dropdown,isManual="manual"==_sd.position,className="".concat(settings.classNames.dropdown);return'<div class="'.concat(isManual?"":className," ").concat(_sd.classname,'" role="listbox" aria-labelledby="dropdown">\n                    <div class="').concat(settings.classNames.dropdownWrapper,'"></div>\n                </div>')},dropdownItem:function dropdownItem(item){return"<div ".concat(this.getAttributes(item),"\n                    class='").concat(this.settings.classNames.dropdownItem," ").concat(item.class?item.class:"",'\'\n                    tabindex="0"\n                    role="option">').concat(item.value,"</div>")},dropdownItemNoMatch:null};function EventDispatcher(instance){var target=document.createTextNode("");function addRemove(op,events,cb){cb&&events.split(/\s+/g).forEach((function(name){return target[op+"EventListener"].call(target,name,cb)}))}return{off:function off(events,cb){return addRemove("remove",events,cb),this},on:function on(events,cb){return cb&&"function"==typeof cb&&addRemove("add",events,cb),this},trigger:function trigger(eventName,data,opts){var e;if(opts=opts||{cloneData:!0},eventName)if(instance.settings.isJQueryPlugin)"remove"==eventName&&(eventName="removeTag"),jQuery(instance.DOM.originalInput).triggerHandler(eventName,[data]);else{try{var eventData="object"===_typeof(data)?data:{value:data};if((eventData=opts.cloneData?extend({},eventData):eventData).tagify=this,data instanceof Object)for(var prop in data)data[prop]instanceof HTMLElement&&(eventData[prop]=data[prop]);e=new CustomEvent(eventName,{detail:eventData})}catch(err){console.warn(err)}target.dispatchEvent(e)}}}}function triggerChangeEvent(){if(!this.settings.mixMode.integrated){var inputElm=this.DOM.originalInput,changed=this.state.lastOriginalValueReported!==inputElm.value,event=new CustomEvent("change",{bubbles:!0});changed&&(this.state.lastOriginalValueReported=inputElm.value,event.simulated=!0,inputElm._valueTracker&&inputElm._valueTracker.setValue(Math.random()),inputElm.dispatchEvent(event),this.trigger("change",this.state.lastOriginalValueReported),inputElm.value=this.state.lastOriginalValueReported)}}var events={customBinding:function customBinding(){var _this2=this;this.customEventsList.forEach((function(name){_this2.on(name,_this2.settings.callbacks[name])}))},binding:function binding(){var bindUnbind=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],_CB=this.events.callbacks,_CBR,action=bindUnbind?"addEventListener":"removeEventListener";if(!this.state.mainEvents||!bindUnbind)for(var eventName in this.state.mainEvents=bindUnbind,bindUnbind&&!this.listeners.main&&(this.DOM.input.addEventListener(this.isIE?"keydown":"input",_CB[this.isIE?"onInputIE":"onInput"].bind(this)),this.settings.isJQueryPlugin&&jQuery(this.DOM.originalInput).on("tagify.removeAllTags",this.removeAllTags.bind(this))),_CBR=this.listeners.main=this.listeners.main||{focus:["input",_CB.onFocusBlur.bind(this)],blur:["input",_CB.onFocusBlur.bind(this)],keydown:["input",_CB.onKeydown.bind(this)],click:["scope",_CB.onClickScope.bind(this)],dblclick:["scope",_CB.onDoubleClickScope.bind(this)],paste:["input",_CB.onPaste.bind(this)]})("blur"!=eventName||bindUnbind)&&this.DOM[_CBR[eventName][0]][action](eventName,_CBR[eventName][1])},callbacks:{onFocusBlur:function onFocusBlur(e){var text=e.target?this.trim(e.target.textContent):"",_s=this.settings,type=e.type,ddEnabled=_s.dropdown.enabled>=0,eventData={relatedTarget:e.relatedTarget},isTargetSelectOption=this.state.actions.selectOption&&(ddEnabled||!_s.dropdown.closeOnSelect),isTargetAddNewBtn=this.state.actions.addNew&&ddEnabled,shouldAddTags;if("blur"==type){if(e.relatedTarget===this.DOM.scope)return this.dropdown.hide.call(this),void this.DOM.input.focus();this.postUpdate(),this.triggerChangeEvent()}if(!isTargetSelectOption&&!isTargetAddNewBtn)if(this.state.hasFocus="focus"==type&&+new Date,this.toggleFocusClass(this.state.hasFocus),"mix"!=_s.mode){if("focus"==type)return this.trigger("focus",eventData),void(0===_s.dropdown.enabled&&this.dropdown.show.call(this));"blur"==type&&(this.trigger("blur",eventData),this.loading(!1),(shouldAddTags="select"==this.settings.mode?!this.value.length||this.value[0].value!=text:text&&!this.state.actions.selectOption&&_s.addTagOnBlur)&&this.addTags(text,!0)),this.DOM.input.removeAttribute("style"),this.dropdown.hide.call(this)}else"focus"==type?this.trigger("focus",eventData):"blur"==e.type&&(this.trigger("blur",eventData),this.loading(!1),this.dropdown.hide.call(this),this.state.dropdown.visible=void 0,this.setStateSelection())},onKeydown:function onKeydown(e){var _this3=this,s=this.trim(e.target.textContent);if(this.trigger("keydown",{originalEvent:this.cloneEvent(e)}),"mix"==this.settings.mode){switch(e.key){case"Left":case"ArrowLeft":this.state.actions.ArrowLeft=!0;break;case"Delete":case"Backspace":if(this.state.editing)return;var sel=document.getSelection(),deleteKeyTagDetected="Delete"==e.key&&sel.anchorOffset==(sel.anchorNode.length||0),isCaretAfterTag=1==sel.anchorNode.nodeType||!sel.anchorOffset&&sel.anchorNode.previousElementSibling,lastInputValue=decode(this.DOM.input.innerHTML),lastTagElems=this.getTagElms(),tagElmToBeDeleted,firstTextNodeBeforeTag;if(isChromeAndroidBrowser&&isCaretAfterTag)return firstTextNodeBeforeTag=getfirstTextNode(isCaretAfterTag),isCaretAfterTag.hasAttribute("readonly")||isCaretAfterTag.remove(),this.DOM.input.focus(),void setTimeout((function(){_this3.placeCaretAfterNode(firstTextNodeBeforeTag),_this3.DOM.input.click()}));if("BR"==sel.anchorNode.nodeName)return;if((deleteKeyTagDetected||isCaretAfterTag)&&1==sel.anchorNode.nodeType?tagElmToBeDeleted=0==sel.anchorOffset?deleteKeyTagDetected?lastTagElems[0]:null:lastTagElems[sel.anchorOffset-1]:deleteKeyTagDetected?tagElmToBeDeleted=sel.anchorNode.nextElementSibling:isCaretAfterTag&&(tagElmToBeDeleted=isCaretAfterTag),3==sel.anchorNode.nodeType&&!sel.anchorNode.nodeValue&&sel.anchorNode.previousElementSibling&&e.preventDefault(),(isCaretAfterTag||deleteKeyTagDetected)&&!this.settings.backspace)return void e.preventDefault();if("Range"!=sel.type&&!sel.anchorOffset&&sel.anchorNode==this.DOM.input&&"Delete"!=e.key)return void e.preventDefault();if("Range"!=sel.type&&tagElmToBeDeleted&&tagElmToBeDeleted.hasAttribute("readonly"))return void this.placeCaretAfterNode(getfirstTextNode(tagElmToBeDeleted));this.isFirefox&&1==sel.anchorNode.nodeType&&0!=sel.anchorOffset&&(this.removeTags(),this.placeCaretAfterNode(this.setRangeAtStartEnd())),setTimeout((function(){var sel=document.getSelection(),currentValue=decode(_this3.DOM.input.innerHTML),prevElm=sel.anchorNode.previousElementSibling;if(!isChromeAndroidBrowser&&currentValue.length>=lastInputValue.length&&prevElm&&!prevElm.hasAttribute("readonly")&&(_this3.removeTags(prevElm),_this3.fixFirefoxLastTagNoCaret(),2==_this3.DOM.input.children.length&&"BR"==_this3.DOM.input.children[1].tagName))return _this3.DOM.input.innerHTML="",_this3.value.length=0,!0;_this3.value=[].map.call(lastTagElems,(function(node,nodeIdx){var tagData=_this3.tagData(node);if(node.parentNode||tagData.readonly)return tagData;_this3.trigger("remove",{tag:node,index:nodeIdx,data:tagData})})).filter((function(n){return n}))}),50)}return!0}switch(e.key){case"Backspace":this.state.dropdown.visible&&"manual"!=this.settings.dropdown.position||""!=s&&8203!=s.charCodeAt(0)||(!0===this.settings.backspace?this.removeTags():"edit"==this.settings.backspace&&setTimeout(this.editTag.bind(this),0));break;case"Esc":case"Escape":if(this.state.dropdown.visible)return;e.target.blur();break;case"Down":case"ArrowDown":this.state.dropdown.visible||this.dropdown.show.call(this);break;case"ArrowRight":var tagData=this.state.inputSuggestion||this.state.ddItemData;if(tagData&&this.settings.autoComplete.rightKey)return void this.addTags([tagData],!0);break;case"Tab":var selectMode="select"==this.settings.mode;if(!s||selectMode)return!0;e.preventDefault();case"Enter":if(this.state.dropdown.visible||229==e.keyCode)return;e.preventDefault(),setTimeout((function(){_this3.state.actions.selectOption||_this3.addTags(s,!0)}))}},onInput:function onInput(e){if("mix"==this.settings.mode)return this.events.callbacks.onMixTagsInput.call(this,e);var value=this.input.normalize.call(this),showSuggestions=value.length>=this.settings.dropdown.enabled,eventData={value:value,inputElm:this.DOM.input};eventData.isValid=this.validateTag({value:value}),this.trigger("input",eventData),this.state.inputText!=value&&(this.input.set.call(this,value,!1),-1!=value.search(this.settings.delimiters)?this.addTags(value)&&this.input.set.call(this):this.settings.dropdown.enabled>=0&&this.dropdown[showSuggestions?"show":"hide"].call(this,value))},onMixTagsInput:function onMixTagsInput(e){var _this4=this,range,rangeText,match,matchedPatternCount,tag,showSuggestions,selection,_s=this.settings,lastTagsCount=this.value.length,matchFlaggedTag,matchDelimiters,tagsElems=this.getTagElms(),fragment=document.createDocumentFragment(),range=window.getSelection().getRangeAt(0),remainingTagsValues=[].map.call(tagsElems,(function(node){return _this4.tagData(node).value}));if("deleteContentBackward"==e.inputType&&isChromeAndroidBrowser&&this.events.callbacks.onKeydown.call(this,{target:e.target,key:"Backspace"}),this.value.slice().forEach((function(item){item.readonly&&!remainingTagsValues.includes(item.value)&&fragment.appendChild(_this4.createTagElem(item))})),fragment.childNodes.length&&(range.insertNode(fragment),this.setRangeAtStartEnd(!1,fragment.lastChild)),tagsElems.length!=lastTagsCount)return this.value=[].map.call(this.getTagElms(),(function(node){return _this4.tagData(node)})),void this.update({withoutChangeEvent:!0});if(this.hasMaxTags())return!0;if(window.getSelection&&(selection=window.getSelection()).rangeCount>0&&3==selection.anchorNode.nodeType){if((range=selection.getRangeAt(0).cloneRange()).collapse(!0),range.setStart(selection.focusNode,0),matchedPatternCount=(rangeText=range.toString().slice(0,range.endOffset)).split(_s.pattern).length-1,(match=rangeText.match(_s.pattern))&&(tag=rangeText.slice(rangeText.lastIndexOf(match[match.length-1]))),tag){if(this.state.actions.ArrowLeft=!1,this.state.tag={prefix:tag.match(_s.pattern)[0],value:tag.replace(_s.pattern,"")},this.state.tag.baseOffset=selection.baseOffset-this.state.tag.value.length,matchDelimiters=this.state.tag.value.match(_s.delimiters))return this.state.tag.value=this.state.tag.value.replace(_s.delimiters,""),this.state.tag.delimiters=matchDelimiters[0],this.addTags(this.state.tag.value,_s.dropdown.clearOnSelect),void this.dropdown.hide.call(this);showSuggestions=this.state.tag.value.length>=_s.dropdown.enabled;try{matchFlaggedTag=(matchFlaggedTag=this.state.flaggedTags[this.state.tag.baseOffset]).prefix==this.state.tag.prefix&&matchFlaggedTag.value[0]==this.state.tag.value[0],this.state.flaggedTags[this.state.tag.baseOffset]&&!this.state.tag.value&&delete this.state.flaggedTags[this.state.tag.baseOffset]}catch(err){}(matchFlaggedTag||matchedPatternCount<this.state.mixMode.matchedPatternCount)&&(showSuggestions=!1)}else this.state.flaggedTags={};this.state.mixMode.matchedPatternCount=matchedPatternCount}setTimeout((function(){_this4.update({withoutChangeEvent:!0}),_this4.trigger("input",extend({},_this4.state.tag,{textContent:_this4.DOM.input.textContent})),_this4.state.tag&&_this4.dropdown[showSuggestions?"show":"hide"].call(_this4,_this4.state.tag.value)}),10)},onInputIE:function onInputIE(e){var _this=this;setTimeout((function(){_this.events.callbacks.onInput.call(_this,e)}))},onClickScope:function onClickScope(e){var _s=this.settings,tagElm=e.target.closest("."+_s.classNames.tag),timeDiffFocus=+new Date-this.state.hasFocus;if(e.target!=this.DOM.scope){if(!e.target.classList.contains(_s.classNames.tagX))return tagElm?(this.trigger("click",{tag:tagElm,index:this.getNodeIndex(tagElm),data:this.tagData(tagElm),originalEvent:this.cloneEvent(e)}),void(1!==_s.editTags&&1!==_s.editTags.clicks||this.events.callbacks.onDoubleClickScope.call(this,e))):void(e.target==this.DOM.input&&("mix"==_s.mode&&this.fixFirefoxLastTagNoCaret(),timeDiffFocus>500)?this.state.dropdown.visible?this.dropdown.hide.call(this):0===_s.dropdown.enabled&&"mix"!=_s.mode&&this.dropdown.show.call(this):"select"==_s.mode&&!this.state.dropdown.visible&&this.dropdown.show.call(this));this.removeTags(e.target.parentNode)}else this.state.hasFocus||this.DOM.input.focus()},onPaste:function onPaste(e){var clipboardData,pastedData;e.preventDefault(),this.settings.readonly||(pastedData=(clipboardData=e.clipboardData||window.clipboardData).getData("Text"),this.injectAtCaret(pastedData,window.getSelection().getRangeAt(0)),"mix"!=this.settings.mode&&this.addTags(this.DOM.input.textContent,!0))},onEditTagInput:function onEditTagInput(editableElm,e){var tagElm=editableElm.closest("."+this.settings.classNames.tag),tagElmIdx=this.getNodeIndex(tagElm),tagData=this.tagData(tagElm),value=this.input.normalize.call(this,editableElm),hasChanged=tagElm.innerHTML!=tagElm.__tagifyTagData.__originalHTML,isValid=this.validateTag(_defineProperty({},this.settings.tagTextProp,value));hasChanged||!0!==editableElm.originalIsValid||(isValid=!0),tagElm.classList.toggle(this.settings.classNames.tagInvalid,!0!==isValid),tagData.__isValid=isValid,tagElm.title=!0===isValid?tagData.title||tagData.value:isValid,value.length>=this.settings.dropdown.enabled&&(this.state.editing&&(this.state.editing.value=value),this.dropdown.show.call(this,value)),this.trigger("edit:input",{tag:tagElm,index:tagElmIdx,data:extend({},this.value[tagElmIdx],{newValue:value}),originalEvent:this.cloneEvent(e)})},onEditTagFocus:function onEditTagFocus(tagElm){this.state.editing={scope:tagElm,input:tagElm.querySelector("[contenteditable]")}},onEditTagBlur:function onEditTagBlur(editableElm){var _extend;if(this.state.hasFocus||this.toggleFocusClass(),this.DOM.scope.contains(editableElm)){var _s=this.settings,tagElm=editableElm.closest("."+_s.classNames.tag),textValue=this.input.normalize.call(this,editableElm),originalData=this.tagData(tagElm).__originalData,hasChanged=tagElm.innerHTML!=tagElm.__tagifyTagData.__originalHTML,isValid=this.validateTag(_defineProperty({},_s.tagTextProp,textValue)),newTagData;if(textValue)if(hasChanged){if(newTagData=this.getWhitelistItem(textValue)||extend({},originalData,(_defineProperty(_extend={},_s.tagTextProp,textValue),_defineProperty(_extend,"value",textValue),_extend)),_s.transformTag.call(this,newTagData,originalData),!0!==(isValid=this.validateTag(_defineProperty({},_s.tagTextProp,newTagData[_s.tagTextProp])))){if(this.trigger("invalid",{data:newTagData,tag:tagElm,message:isValid}),_s.editTags.keepInvalid)return;_s.keepInvalidTags?newTagData.__isValid=isValid:newTagData=originalData}this.onEditTagDone(tagElm,newTagData)}else this.onEditTagDone(tagElm,originalData);else this.onEditTagDone(tagElm)}},onEditTagkeydown:function onEditTagkeydown(e,tagElm){switch(this.trigger("edit:keydown",{originalEvent:this.cloneEvent(e)}),e.key){case"Esc":case"Escape":tagElm.innerHTML=tagElm.__tagifyTagData.__originalHTML;case"Enter":case"Tab":e.preventDefault(),e.target.blur()}},onDoubleClickScope:function onDoubleClickScope(e){var tagElm=e.target.closest("."+this.settings.classNames.tag),_s=this.settings,isEditingTag,isReadyOnlyTag;tagElm&&(isEditingTag=tagElm.classList.contains(this.settings.classNames.tagEditing),isReadyOnlyTag=tagElm.hasAttribute("readonly"),"select"==_s.mode||_s.readonly||isEditingTag||isReadyOnlyTag||!this.settings.editTags||this.editTag(tagElm),this.toggleFocusClass(!0),this.trigger("dblclick",{tag:tagElm,index:this.getNodeIndex(tagElm),data:this.tagData(tagElm)}))}}};function Tagify(input,settings){return input?input.previousElementSibling&&input.previousElementSibling.classList.contains("tagify")?(console.warn("Tagify: ","input element is already Tagified",input),this):(extend(this,EventDispatcher(this)),this.isFirefox="undefined"!=typeof InstallTrigger,this.isIE=window.document.documentMode,this.applySettings(input,settings||{}),this.state={inputText:"",editing:!1,actions:{},mixMode:{},dropdown:{},flaggedTags:{}},this.value=[],this.listeners={},this.DOM={},this.build(input),this.getCSSVars(),this.loadOriginalValues(),this.events.customBinding.call(this),this.events.binding.call(this),void(input.autofocus&&this.DOM.input.focus())):(console.warn("Tagify: ","input element not found",input),this)}return Tagify.prototype={dropdown:dropdownMethods,TEXTS:{empty:"empty",exceed:"number of tags exceeded",pattern:"pattern mismatch",duplicate:"already exists",notAllowed:"not allowed"},customEventsList:["change","add","remove","invalid","input","click","keydown","focus","blur","edit:input","edit:beforeUpdate","edit:updated","edit:start","edit:keydown","dropdown:show","dropdown:hide","dropdown:select","dropdown:updated","dropdown:noMatch"],trim:function trim(text){return this.settings.trim&&text&&"string"==typeof text?text.trim():text},parseHTML:parseHTML,templates:templates,parseTemplate:function parseTemplate(template,data){return template=this.settings.templates[template]||template,this.parseHTML(template.apply(this,data))},applySettings:function applySettings(input,settings){DEFAULTS.templates=this.templates;var _s=this.settings=extend({},DEFAULTS,settings);_s.readonly=input.hasAttribute("readonly"),_s.placeholder=input.getAttribute("placeholder")||_s.placeholder||"",_s.required=input.hasAttribute("required");var _loop=function _loop(name){Object.defineProperty(_s.classNames,name+"Selector",{get:function get(){return"."+this[name].split(" ").join(".")}})};for(var name in _s.classNames)_loop(name);if(this.isIE&&(_s.autoComplete=!1),["whitelist","blacklist"].forEach((function(name){var attrVal=input.getAttribute("data-"+name);attrVal&&(attrVal=attrVal.split(_s.delimiters))instanceof Array&&(_s[name]=attrVal)})),"autoComplete"in settings&&!isObject(settings.autoComplete)&&(_s.autoComplete=DEFAULTS.autoComplete,_s.autoComplete.enabled=settings.autoComplete),"mix"==_s.mode&&(_s.autoComplete.rightKey=!0,_s.delimiters=settings.delimiters||null,_s.tagTextProp&&!_s.dropdown.searchKeys.includes(_s.tagTextProp)&&_s.dropdown.searchKeys.push(_s.tagTextProp)),input.pattern)try{_s.pattern=new RegExp(input.pattern)}catch(e){}if(this.settings.delimiters)try{_s.delimiters=new RegExp(this.settings.delimiters,"g")}catch(e){}"select"==_s.mode&&(_s.dropdown.enabled=0),_s.dropdown.appendTarget=settings.dropdown&&settings.dropdown.appendTarget?settings.dropdown.appendTarget:document.body},getAttributes:function getAttributes(data){if("[object Object]"!=Object.prototype.toString.call(data))return"";var keys=Object.keys(data),s="",propName,i;for(i=keys.length;i--;)"class"!=(propName=keys[i])&&data.hasOwnProperty(propName)&&void 0!==data[propName]&&(s+=" "+propName+(void 0!==data[propName]?'="'.concat(data[propName],'"'):""));return s},setStateSelection:function setStateSelection(){var selection=window.getSelection(),sel={anchorOffset:selection.anchorOffset,anchorNode:selection.anchorNode,range:selection.getRangeAt&&selection.rangeCount&&selection.getRangeAt(0)};return this.state.selection=sel,sel},getCaretGlobalPosition:function getCaretGlobalPosition(){var sel=document.getSelection();if(sel.rangeCount){var r=sel.getRangeAt(0),node=r.startContainer,offset=r.startOffset,rect,r2;if(offset>0)return(r2=document.createRange()).setStart(node,offset-1),r2.setEnd(node,offset),{left:(rect=r2.getBoundingClientRect()).right,top:rect.top,bottom:rect.bottom};if(node.getBoundingClientRect)return node.getBoundingClientRect()}return{left:-9999,top:-9999}},getCSSVars:function getCSSVars(){var compStyle=getComputedStyle(this.DOM.scope,null),getProp=function getProp(name){return compStyle.getPropertyValue("--"+name)},_ref,value,unit;function seprateUnitFromValue(a){if(!a)return{};var unit=(a=a.trim().split(" ")[0]).split(/\d+/g).filter((function(n){return n})).pop().trim(),value;return{value:+a.split(unit).filter((function(n){return n}))[0].trim(),unit:unit}}this.CSSVars={tagHideTransition:(_ref=seprateUnitFromValue(getProp("tag-hide-transition")),value=_ref.value,"s"==_ref.unit?1e3*value:value)}},build:function build(input){var DOM=this.DOM;this.settings.mixMode.integrated?(DOM.originalInput=null,DOM.scope=input,DOM.input=input):(DOM.originalInput=input,DOM.scope=this.parseTemplate("wrapper",[input,this.settings]),DOM.input=DOM.scope.querySelector(this.settings.classNames.inputSelector),input.parentNode.insertBefore(DOM.scope,input)),this.settings.dropdown.enabled>=0&&this.dropdown.init.call(this)},destroy:function destroy(){this.DOM.scope.parentNode.removeChild(this.DOM.scope),this.dropdown.hide.call(this,!0),clearTimeout(this.dropdownHide__bindEventsTimeout)},loadOriginalValues:function loadOriginalValues(value){var lastChild,_s=this.settings;if(value=value||(_s.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value))if(this.removeAllTags({withoutChangeEvent:!0}),"mix"==_s.mode)this.parseMixTags(value.trim()),(lastChild=this.DOM.input.lastChild)&&"BR"==lastChild.tagName||this.DOM.input.insertAdjacentHTML("beforeend","<br>");else{try{JSON.parse(value)instanceof Array&&(value=JSON.parse(value))}catch(err){}this.addTags(value).forEach((function(tag){return tag&&tag.classList.add(_s.classNames.tagNoAnimation)}))}else this.postUpdate();this.state.lastOriginalValueReported=_s.mixMode.integrated?"":this.DOM.originalInput.value,this.state.loadedOriginalValues=!0},cloneEvent:function cloneEvent(e){var clonedEvent={};for(var v in e)clonedEvent[v]=e[v];return clonedEvent},loading:function loading(isLoading){return this.state.isLoading=isLoading,this.DOM.scope.classList[isLoading?"add":"remove"](this.settings.classNames.scopeLoading),this},tagLoading:function tagLoading(tagElm,isLoading){return tagElm&&tagElm.classList[isLoading?"add":"remove"](this.settings.classNames.tagLoading),this},toggleClass:function toggleClass(className,force){"string"==typeof className&&this.DOM.scope.classList.toggle(className,force)},toggleFocusClass:function toggleFocusClass(force){this.toggleClass(this.settings.classNames.focus,!!force)},triggerChangeEvent:triggerChangeEvent,events:events,fixFirefoxLastTagNoCaret:function fixFirefoxLastTagNoCaret(){},placeCaretAfterNode:function placeCaretAfterNode(node){if(node&&node.parentNode){var nextSibling=node.nextSibling,sel=window.getSelection(),range=sel.getRangeAt(0);sel.rangeCount&&(range.setStartBefore(nextSibling||node),range.setEndBefore(nextSibling||node),sel.removeAllRanges(),sel.addRange(range))}},insertAfterTag:function insertAfterTag(tagElm,newNode){if(newNode=newNode||this.settings.mixMode.insertAfterTag,tagElm&&tagElm.parentNode&&newNode)return newNode="string"==typeof newNode?document.createTextNode(newNode):newNode,tagElm.parentNode.insertBefore(newNode,tagElm.nextSibling),newNode},editTag:function editTag(tagElm,opts){var _this=this;tagElm=tagElm||this.getLastTag(),opts=opts||{},this.dropdown.hide.call(this);var _s=this.settings;function getEditableElm(){return tagElm.querySelector(_s.classNames.tagTextSelector)}var editableElm=getEditableElm(),tagIdx=this.getNodeIndex(tagElm),tagData=this.tagData(tagElm),_CB=this.events.callbacks,that=this,isValid=!0,delayed_onEditTagBlur=function delayed_onEditTagBlur(){setTimeout((function(){return _CB.onEditTagBlur.call(that,getEditableElm())}))};if(editableElm){if(!(tagData instanceof Object&&"editable"in tagData)||tagData.editable)return editableElm.setAttribute("contenteditable",!0),tagElm.classList.add(_s.classNames.tagEditing),this.tagData(tagElm,{__originalData:extend({},tagData),__originalHTML:tagElm.innerHTML}),editableElm.addEventListener("focus",_CB.onEditTagFocus.bind(this,tagElm)),editableElm.addEventListener("blur",delayed_onEditTagBlur),editableElm.addEventListener("input",_CB.onEditTagInput.bind(this,editableElm)),editableElm.addEventListener("keydown",(function(e){return _CB.onEditTagkeydown.call(_this,e,tagElm)})),editableElm.focus(),this.setRangeAtStartEnd(!1,editableElm),opts.skipValidation||(isValid=this.editTagToggleValidity(tagElm,tagData.value)),editableElm.originalIsValid=isValid,this.trigger("edit:start",{tag:tagElm,index:tagIdx,data:tagData,isValid:isValid}),this}else console.warn("Cannot find element in Tag template: .",_s.classNames.tagTextSelector)},editTagToggleValidity:function editTagToggleValidity(tagElm,value){var tagData=this.tagData(tagElm),toggleState;if(tagData)return toggleState=!(!tagData.__isValid||1==tagData.__isValid),tagElm.classList.toggle(this.settings.classNames.tagInvalid,toggleState),tagData.__isValid;console.warn("tag has no data: ",tagElm,tagData)},onEditTagDone:function onEditTagDone(tagElm,tagData){tagData=tagData||{};var eventData={tag:tagElm=tagElm||this.state.editing.scope,index:this.getNodeIndex(tagElm),previousData:this.tagData(tagElm),data:tagData};this.trigger("edit:beforeUpdate",eventData,{cloneData:!1}),this.state.editing=!1,delete tagData.__originalData,delete tagData.__originalHTML,tagElm&&tagData[this.settings.tagTextProp]?(this.editTagToggleValidity(tagElm),this.replaceTag(tagElm,tagData)):tagElm&&this.removeTags(tagElm),this.trigger("edit:updated",eventData),this.dropdown.hide.call(this),this.settings.keepInvalidTags&&this.reCheckInvalidTags()},replaceTag:function replaceTag(tagElm,tagData){tagData&&tagData.value||(tagData=tagElm.__tagifyTagData),tagData.__isValid&&1!=tagData.__isValid&&extend(tagData,this.getInvalidTagAttrs(tagData,tagData.__isValid));var newTag=this.createTagElem(tagData);tagElm.parentNode.replaceChild(newTag,tagElm),this.updateValueByDOMTags()},updateValueByDOMTags:function updateValueByDOMTags(){var _this2=this;this.value.length=0,[].forEach.call(this.getTagElms(),(function(node){node.classList.contains(_this2.settings.classNames.tagNotAllowed.split(" ")[0])||_this2.value.push(_this2.tagData(node))})),this.update()},setRangeAtStartEnd:function setRangeAtStartEnd(start,node){start="number"==typeof start?start:!!start,node=(node=node||this.DOM.input).lastChild||node;var sel=document.getSelection();try{sel.rangeCount>=1&&["Start","End"].forEach((function(pos){return sel.getRangeAt(0)["set"+pos](node,start||node.length)}))}catch(err){console.warn("Tagify: ",err)}},injectAtCaret:function injectAtCaret(injectedNode,range){if(range=range||this.state.selection.range)return"string"==typeof injectedNode&&(injectedNode=document.createTextNode(injectedNode)),range.deleteContents(),range.insertNode(injectedNode),this.setRangeAtStartEnd(!1,injectedNode),this.updateValueByDOMTags(),this.update(),this},input:{set:function set(){var s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",updateDOM=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],hideDropdown=this.settings.dropdown.closeOnSelect;this.state.inputText=s,updateDOM&&(this.DOM.input.innerHTML=escapeHTML(""+s)),!s&&hideDropdown&&this.dropdown.hide.bind(this),this.input.autocomplete.suggest.call(this),this.input.validate.call(this)},validate:function validate(){var isValid=!this.state.inputText||!0===this.validateTag({value:this.state.inputText});return this.DOM.input.classList.toggle(this.settings.classNames.inputInvalid,!isValid),isValid},normalize:function normalize(node){var clone=node||this.DOM.input,v=[];clone.childNodes.forEach((function(n){return 3==n.nodeType&&v.push(n.nodeValue)})),v=v.join("\n");try{v=v.replace(/(?:\r\n|\r|\n)/g,this.settings.delimiters.source.charAt(0))}catch(err){}return v=v.replace(/\s/g," "),this.settings.trim&&(v=v.replace(/^\s+/,"")),v},autocomplete:{suggest:function suggest(data){if(this.settings.autoComplete.enabled){"string"==typeof(data=data||{})&&(data={value:data});var suggestedText=data.value?""+data.value:"",suggestionStart=suggestedText.substr(0,this.state.inputText.length).toLowerCase(),suggestionTrimmed=suggestedText.substring(this.state.inputText.length);suggestedText&&this.state.inputText&&suggestionStart==this.state.inputText.toLowerCase()?(this.DOM.input.setAttribute("data-suggest",suggestionTrimmed),this.state.inputSuggestion=data):(this.DOM.input.removeAttribute("data-suggest"),delete this.state.inputSuggestion)}},set:function set(s){var dataSuggest=this.DOM.input.getAttribute("data-suggest"),suggestion=s||(dataSuggest?this.state.inputText+dataSuggest:null);return!!suggestion&&("mix"==this.settings.mode?this.replaceTextWithNode(document.createTextNode(this.state.tag.prefix+suggestion)):(this.input.set.call(this,suggestion),this.setRangeAtStartEnd()),this.input.autocomplete.suggest.call(this),this.dropdown.hide.call(this),!0)}}},getTagIdx:function getTagIdx(tagData){return this.value.findIndex((function(item){return item.value==tagData.value}))},getNodeIndex:function getNodeIndex(node){var index=0;if(node)for(;node=node.previousElementSibling;)index++;return index},getTagElms:function getTagElms(){for(var _len=arguments.length,classess=new Array(_len),_key=0;_key<_len;_key++)classess[_key]=arguments[_key];var classname="."+[].concat(_toConsumableArray(this.settings.classNames.tag.split(" ")),classess).join(".");return[].slice.call(this.DOM.scope.querySelectorAll(classname))},getLastTag:function getLastTag(){var lastTag=this.DOM.scope.querySelectorAll("".concat(this.settings.classNames.tagSelector,":not(.").concat(this.settings.classNames.tagHide,"):not([readonly])"));return lastTag[lastTag.length-1]},tagData:function tagData(tagElm,data,override){return tagElm?(data&&(tagElm.__tagifyTagData=override?data:extend({},tagElm.__tagifyTagData||{},data)),tagElm.__tagifyTagData):(console.warn("tag elment doesn't exist",tagElm,data),data)},isTagDuplicate:function isTagDuplicate(value,caseSensitive){var _this3=this,duplications,_s=this.settings;return"select"!=_s.mode&&(duplications=this.value.reduce((function(acc,item){return sameStr(_this3.trim(""+value),item.value,caseSensitive||_s.dropdown.caseSensitive)?acc+1:acc}),0))},getTagIndexByValue:function getTagIndexByValue(value){var _this4=this,indices=[];return this.getTagElms().forEach((function(tagElm,i){sameStr(_this4.trim(tagElm.textContent),value,_this4.settings.dropdown.caseSensitive)&&indices.push(i)})),indices},getTagElmByValue:function getTagElmByValue(value){var tagIdx=this.getTagIndexByValue(value)[0];return this.getTagElms()[tagIdx]},flashTag:function flashTag(tagElm){var _this5=this;tagElm&&(tagElm.classList.add(this.settings.classNames.tagFlash),setTimeout((function(){tagElm.classList.remove(_this5.settings.classNames.tagFlash)}),100))},isTagBlacklisted:function isTagBlacklisted(v){return v=this.trim(v.toLowerCase()),this.settings.blacklist.filter((function(x){return(""+x).toLowerCase()==v})).length},isTagWhitelisted:function isTagWhitelisted(v){return!!this.getWhitelistItem(v)},getWhitelistItem:function getWhitelistItem(value,prop,whitelist){var result,prop=prop||"value",_s=this.settings,whitelist;return(whitelist=whitelist||_s.whitelist).some((function(_wi){var _wiv="string"==typeof _wi?_wi:_wi[prop]||_wi.value,isSameStr;if(sameStr(_wiv,value,_s.dropdown.caseSensitive,_s.trim))return result="string"==typeof _wi?{value:_wi}:_wi,!0})),result||"value"!=prop||"value"==_s.tagTextProp||(result=this.getWhitelistItem(value,_s.tagTextProp,whitelist)),result},validateTag:function validateTag(tagData){var _s=this.settings,prop="value"in tagData?"value":_s.tagTextProp,v=this.trim(tagData[prop]+"");return(tagData[prop]+"").trim()?_s.pattern&&_s.pattern instanceof RegExp&&!_s.pattern.test(v)?this.TEXTS.pattern:!_s.duplicates&&this.isTagDuplicate(v,this.state.editing)?this.TEXTS.duplicate:this.isTagBlacklisted(v)||_s.enforceWhitelist&&!this.isTagWhitelisted(v)?this.TEXTS.notAllowed:!_s.validate||_s.validate(tagData):this.TEXTS.empty},getInvalidTagAttrs:function getInvalidTagAttrs(tagData,validation){return{"aria-invalid":!0,class:"".concat(tagData.class||""," ").concat(this.settings.classNames.tagNotAllowed).trim(),title:validation}},hasMaxTags:function hasMaxTags(){return this.value.length>=this.settings.maxTags&&this.TEXTS.exceed},setReadonly:function setReadonly(isReadonly){var _s=this.settings;document.activeElement.blur(),_s.readonly=isReadonly,this.DOM.scope[(isReadonly?"set":"remove")+"Attribute"]("readonly",!0),"mix"==_s.mode&&(this.DOM.input.contentEditable=!isReadonly)},normalizeTags:function normalizeTags(tagsItems){var _this6=this,_this$settings=this.settings,whitelist=_this$settings.whitelist,delimiters=_this$settings.delimiters,mode=_this$settings.mode,tagTextProp=_this$settings.tagTextProp,enforceWhitelist=_this$settings.enforceWhitelist,whitelistMatches=[],whitelistWithProps=!!whitelist&&whitelist[0]instanceof Object,isArray=tagsItems instanceof Array,mapStringToCollection=function mapStringToCollection(s){return(s+"").split(delimiters).filter((function(n){return n})).map((function(v){var _ref2;return _defineProperty(_ref2={},tagTextProp,_this6.trim(v)),_defineProperty(_ref2,"value",_this6.trim(v)),_ref2}))};if("number"==typeof tagsItems&&(tagsItems=tagsItems.toString()),"string"==typeof tagsItems){if(!tagsItems.trim())return[];tagsItems=mapStringToCollection(tagsItems)}else if(isArray){var _ref3;tagsItems=(_ref3=[]).concat.apply(_ref3,_toConsumableArray(tagsItems.map((function(item){return item.value?item:mapStringToCollection(item)}))))}return whitelistWithProps&&(tagsItems.forEach((function(item){var whitelistMatchesValues=whitelistMatches.map((function(a){return a.value})),filteredList=_this6.dropdown.filterListItems.call(_this6,item[tagTextProp],{exact:!0}).filter((function(filteredItem){return!whitelistMatchesValues.includes(filteredItem.value)})),matchObj=filteredList.length>1?_this6.getWhitelistItem(item[tagTextProp],tagTextProp,filteredList):filteredList[0];matchObj&&matchObj instanceof Object?whitelistMatches.push(matchObj):"mix"==mode||enforceWhitelist||(null==item.value&&(item.value=item[tagTextProp]),whitelistMatches.push(item))})),tagsItems=whitelistMatches),tagsItems},parseMixTags:function parseMixTags(s){var _this7=this,_this$settings2=this.settings,mixTagsInterpolator=_this$settings2.mixTagsInterpolator,duplicates=_this$settings2.duplicates,transformTag=_this$settings2.transformTag,enforceWhitelist=_this$settings2.enforceWhitelist,maxTags=_this$settings2.maxTags,tagTextProp=_this$settings2.tagTextProp,tagsDataSet=[];return s=s.split(mixTagsInterpolator[0]).map((function(s1,i){var s2=s1.split(mixTagsInterpolator[1]),preInterpolated=s2[0],maxTagsReached=tagsDataSet.length==maxTags,textProp,tagData,tagElm;try{if(preInterpolated==+preInterpolated)throw Error;tagData=JSON.parse(preInterpolated)}catch(err){tagData=_this7.normalizeTags(preInterpolated)[0]||{value:preInterpolated}}if(maxTagsReached||!(s2.length>1)||enforceWhitelist&&!_this7.isTagWhitelisted(tagData.value)||!duplicates&&_this7.isTagDuplicate(tagData.value)){if(s1)return i?mixTagsInterpolator[0]+s1:s1}else transformTag.call(_this7,tagData),tagData[textProp=tagData[tagTextProp]?tagTextProp:"value"]=_this7.trim(tagData[textProp]),tagElm=_this7.createTagElem(tagData),tagsDataSet.push(tagData),tagElm.classList.add(_this7.settings.classNames.tagNoAnimation),s2[0]=tagElm.outerHTML,_this7.value.push(tagData);return s2.join("")})).join(""),this.DOM.input.innerHTML=s,this.DOM.input.appendChild(document.createTextNode("")),this.DOM.input.normalize(),this.getTagElms().forEach((function(elm,idx){return _this7.tagData(elm,tagsDataSet[idx])})),this.update({withoutChangeEvent:!0}),s},replaceTextWithNode:function replaceTextWithNode(newWrapperNode,strToReplace){if(this.state.tag||strToReplace){strToReplace=strToReplace||this.state.tag.prefix+this.state.tag.value;var idx,nodeToReplace,selection=window.getSelection(),nodeAtCaret=selection.anchorNode,firstSplitOffset=this.state.tag.delimiters?this.state.tag.delimiters.length:0;return nodeAtCaret.splitText(selection.anchorOffset-firstSplitOffset),idx=nodeAtCaret.nodeValue.lastIndexOf(strToReplace),nodeToReplace=nodeAtCaret.splitText(idx),newWrapperNode&&nodeAtCaret.parentNode.replaceChild(newWrapperNode,nodeToReplace),!0}},selectTag:function selectTag(tagElm,tagData){if(!this.settings.enforceWhitelist||this.isTagWhitelisted(tagData.value))return this.input.set.call(this,tagData.value,!0),this.state.actions.selectOption&&setTimeout(this.setRangeAtStartEnd.bind(this)),this.getLastTag()?this.replaceTag(this.getLastTag(),tagData):this.appendTag(tagElm),this.value[0]=tagData,this.trigger("add",{tag:tagElm,data:tagData}),this.update(),[tagElm]},addEmptyTag:function addEmptyTag(initialData){var tagData=extend({value:""},initialData||{}),tagElm=this.createTagElem(tagData);this.tagData(tagElm,tagData),this.appendTag(tagElm),this.editTag(tagElm,{skipValidation:!0})},addTags:function addTags(tagsItems,clearInput){var _this8=this,skipInvalid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.settings.skipInvalid,tagElems=[],_s=this.settings;return tagsItems&&0!=tagsItems.length?(tagsItems=this.normalizeTags(tagsItems),"mix"==_s.mode?this.addMixTags(tagsItems):("select"==_s.mode&&(clearInput=!1),this.DOM.input.removeAttribute("style"),tagsItems.forEach((function(tagData){var tagElm,tagElmParams={},originalData=Object.assign({},tagData,{value:tagData.value+""});if((tagData=Object.assign({},originalData)).__isValid=_this8.hasMaxTags()||_this8.validateTag(tagData),_s.transformTag.call(_this8,tagData),!0!==tagData.__isValid){if(skipInvalid)return;extend(tagElmParams,_this8.getInvalidTagAttrs(tagData,tagData.__isValid),{__preInvalidData:originalData}),tagData.__isValid==_this8.TEXTS.duplicate&&_this8.flashTag(_this8.getTagElmByValue(tagData.value))}if(tagData.readonly&&(tagElmParams["aria-readonly"]=!0),tagElm=_this8.createTagElem(extend({},tagData,tagElmParams)),tagElems.push(tagElm),"select"==_s.mode)return _this8.selectTag(tagElm,tagData);_this8.appendTag(tagElm),tagData.__isValid&&!0===tagData.__isValid?(_this8.value.push(tagData),_this8.update(),_this8.trigger("add",{tag:tagElm,index:_this8.value.length-1,data:tagData})):(_this8.trigger("invalid",{data:tagData,index:_this8.value.length,tag:tagElm,message:tagData.__isValid}),_s.keepInvalidTags||setTimeout((function(){return _this8.removeTags(tagElm,!0)}),1e3)),_this8.dropdown.position.call(_this8)})),tagsItems.length&&clearInput&&this.input.set.call(this),this.dropdown.refilter.call(this),tagElems)):("select"==_s.mode&&this.removeAllTags(),tagElems)},addMixTags:function addMixTags(tagsData){var _this9=this;if(tagsData[0].prefix||this.state.tag)this.prefixedTextToTag(tagsData[0]);else{"string"==typeof tagsData&&(tagsData=[{value:tagsData}]);var selection=!!this.state.selection,frag=document.createDocumentFragment();tagsData.forEach((function(tagData){var tagElm=_this9.createTagElem(tagData);frag.appendChild(tagElm),_this9.insertAfterTag(tagElm)})),selection?this.injectAtCaret(frag):(this.DOM.input.focus(),(selection=this.setStateSelection()).range.setStart(this.DOM.input,selection.range.endOffset),selection.range.setEnd(this.DOM.input,selection.range.endOffset),this.DOM.input.appendChild(frag),this.updateValueByDOMTags(),this.update())}},prefixedTextToTag:function prefixedTextToTag(tagsItem){var _this10=this,_s=this.settings,tagElm,createdFromDelimiters=this.state.tag.delimiters;if(_s.transformTag.call(this,tagsItem),tagsItem.prefix=tagsItem.prefix||this.state.tag?this.state.tag.prefix:(_s.pattern.source||_s.pattern)[0],tagElm=this.createTagElem(tagsItem),this.replaceTextWithNode(tagElm)||this.DOM.input.appendChild(tagElm),setTimeout((function(){return tagElm.classList.add(_this10.settings.classNames.tagNoAnimation)}),300),this.value.push(tagsItem),this.update(),!createdFromDelimiters){var elm=this.insertAfterTag(tagElm)||tagElm;this.placeCaretAfterNode(elm)}return this.state.tag=null,this.trigger("add",extend({},{tag:tagElm},{data:tagsItem})),tagElm},appendTag:function appendTag(tagElm){var insertBeforeNode=this.DOM.scope.lastElementChild;insertBeforeNode===this.DOM.input?this.DOM.scope.insertBefore(tagElm,insertBeforeNode):this.DOM.scope.appendChild(tagElm)},createTagElem:function createTagElem(tagData){var tagElm,templateData=extend({},tagData,{value:escapeHTML(tagData.value+"")});return removeTextChildNodes(tagElm=this.parseTemplate("tag",[templateData])),this.tagData(tagElm,tagData),tagElm},reCheckInvalidTags:function reCheckInvalidTags(){var _this11=this,_s=this.settings,selector="".concat(_s.classNames.tagSelector).concat(_s.classNames.tagNotAllowedSelector),tagElms=this.DOM.scope.querySelectorAll(selector);[].forEach.call(tagElms,(function(node){var tagData=_this11.tagData(node),wasNodeDuplicate=node.getAttribute("title")==_this11.TEXTS.duplicate,isNodeValid=!0===_this11.validateTag(tagData);wasNodeDuplicate&&isNodeValid&&(tagData=tagData.__preInvalidData?tagData.__preInvalidData:{value:tagData.value},_this11.replaceTag(node,tagData))}))},removeTags:function removeTags(tagElms,silent,tranDuration){var _this12=this,tagsToRemove;tagElms=tagElms&&tagElms instanceof HTMLElement?[tagElms]:tagElms instanceof Array?tagElms:tagElms?[tagElms]:[this.getLastTag()],tagsToRemove=tagElms.reduce((function(elms,tagElm){return tagElm&&"string"==typeof tagElm&&(tagElm=_this12.getTagElmByValue(tagElm)),tagElm&&elms.push({node:tagElm,idx:_this12.getTagIdx(_this12.tagData(tagElm)),data:_this12.tagData(tagElm,{__removed:!0})}),elms}),[]),tranDuration="number"==typeof tranDuration?tranDuration:this.CSSVars.tagHideTransition,"select"==this.settings.mode&&(tranDuration=0,this.input.set.call(this)),1==tagsToRemove.length&&tagsToRemove[0].node.classList.contains(this.settings.classNames.tagNotAllowed)&&(silent=!0),tagsToRemove.length&&this.settings.hooks.beforeRemoveTag(tagsToRemove,{tagify:this}).then((function(){function removeNode(tag){tag.node.parentNode&&(tag.node.parentNode.removeChild(tag.node),silent?this.settings.keepInvalidTags&&this.trigger("remove",{tag:tag.node,index:tag.idx}):(this.trigger("remove",{tag:tag.node,index:tag.idx,data:tag.data}),this.dropdown.refilter.call(this),this.dropdown.position.call(this),this.DOM.input.normalize(),this.settings.keepInvalidTags&&this.reCheckInvalidTags()))}function animation(tag){tag.node.style.width=parseFloat(window.getComputedStyle(tag.node).width)+"px",document.body.clientTop,tag.node.classList.add(this.settings.classNames.tagHide),setTimeout(removeNode.bind(this),tranDuration,tag)}tranDuration&&tranDuration>10&&1==tagsToRemove.length?animation.call(_this12,tagsToRemove[0]):tagsToRemove.forEach(removeNode.bind(_this12)),silent||(tagsToRemove.forEach((function(tag){var tagData=Object.assign({},tag.data);delete tagData.__removed;var tagIdx=_this12.getTagIdx(tagData);tagIdx>-1&&_this12.value.splice(tagIdx,1)})),_this12.update())})).catch((function(reason){}))},removeAllTags:function removeAllTags(opts){var withoutChangeEvent=opts||{};this.value=[],"mix"==this.settings.mode?this.DOM.input.innerHTML="":Array.prototype.slice.call(this.getTagElms()).forEach((function(elm){return elm.parentNode.removeChild(elm)})),this.dropdown.position.call(this),"select"==this.settings.mode&&this.input.set.call(this),this.update({withoutChangeEvent:withoutChangeEvent})},postUpdate:function postUpdate(){var classNames=this.settings.classNames,hasValue="mix"==this.settings.mode?this.settings.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value:this.value.length;this.toggleClass(classNames.hasMaxTags,this.value.length>=this.settings.maxTags),this.toggleClass(classNames.hasNoTags,!this.value.length),this.toggleClass(classNames.empty,!hasValue)},update:function update(args){var inputElm=this.DOM.originalInput,_ref4,withoutChangeEvent=(args||{}).withoutChangeEvent,value=removeCollectionProp(this.value,["__isValid","__removed"]);this.settings.mixMode.integrated||(inputElm.value="mix"==this.settings.mode?this.getMixedTagsAsString(value):value.length?this.settings.originalInputValueFormat?this.settings.originalInputValueFormat(value):JSON.stringify(value):""),this.postUpdate(),!withoutChangeEvent&&this.state.loadedOriginalValues&&this.triggerChangeEvent()},getMixedTagsAsString:function getMixedTagsAsString(){var result="",that=this,_interpolator=this.settings.mixTagsInterpolator;function iterateChildren(rootNode){rootNode.childNodes.forEach((function(node){if(1==node.nodeType){if(node.classList.contains(that.settings.classNames.tag)&&that.tagData(node)){if(that.tagData(node).__removed)return;return void(result+=_interpolator[0]+JSON.stringify(node.__tagifyTagData)+_interpolator[1])}"BR"!=node.tagName||node.parentNode!=that.DOM.input&&1!=node.parentNode.childNodes.length?"DIV"!=node.tagName&&"P"!=node.tagName||(result+="\r\n",iterateChildren(node)):result+="\r\n"}else result+=node.textContent}))}return iterateChildren(this.DOM.input),result}},Tagify.prototype.removeTag=Tagify.prototype.removeTags,Tagify}));