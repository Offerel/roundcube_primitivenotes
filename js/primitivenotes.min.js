function uplMedia(){document.getElementById("dropMedia").click()}function osource(){let e=document.getElementById("source");e.readOnly&&e.value.length>1&&window.open(e.value,"_blank").focus()}function pasteParse(e){function t(e,t,n){let o=new XMLHttpRequest;o.onload=function(){if(200==o.status)mde.codemirror.replaceSelection(o.responseText),loader.remove();else{let e="Server Error! Upload failed. Can not connect to server";console.error(e),rcmail.display_message(e,"error")}},o.onerror=function(){let e="Server Error! Upload failed. Can not connect to server";console.error(e),rcmail.display_message(e,"error")};let l=new FormData;l.append("dropFile",e),o.open("POST",location.href+"&_action=uplMedia"),o.send(l)}e.preventDefault(),e.stopPropagation();const n=e.clipboardData.getData("text/html")||e.clipboardData.getData("text/plain"),o=e.clipboardData.types;for(var l=0;l<e.clipboardData.items.length;l++){let n=e.clipboardData.items[l];if(-1!=n.type.indexOf("image")){let o=e.clipboardData.getData("text/html");if(o.indexOf('alt="')>=0){let e=o.indexOf('alt="')+5,t=o.indexOf('"',e);var d=o.substr(e,t-e)}else d="";if(o.indexOf('title="')>=0){let e=o.indexOf('title="')+7,t=o.indexOf('"',e);var i=o.substr(e,t-e)}else i="";return document.getElementById("main_area").appendChild(loader),t(n.getAsFile(),d,i),!1}}let a={headingStyle:"atx",hr:"-",bulletListMarker:"-",codeBlockStyle:"fenced",fence:"```",emDelimiter:"*",strongDelimiter:"**",linkStyle:"inlined",linkReferenceStyle:"full",collapseMultipleWhitespaces:!0,preformattedCode:!0},s=new window.TurndownService(a);s.addRule("kbd",{filter:["kbd"],replacement:function(e){return"<kbd>"+e+"</kbd>"}});let c=o.includes("text/html")?s.turndown(n):n;if(c.startsWith("---")){let e=c.split("\n"),t=c.indexOf("---",4)+3;for(let t=1;t<10&&"---"!=e[t];t++){let n=e[t].split(":");"tags"==n[0]&&tagify.addTags(n[1]),"author"==n[0]&&(document.getElementById("author").value=n[1].trim()),"created"==n[0]&&(document.getElementById("created").value=n.slice(1).join(":").trim()),"modified"==n[0]&&(document.getElementById("modified").value=n.slice(1).join(":").trim()),"source"==n[0]&&(document.getElementById("source").value=n.slice(1).join(":").trim())}c=c.substr(t).trim()}mde.codemirror.replaceSelection(c)}function manageDropUpload(e){document.getElementById("main_area").appendChild(loader);for(let t of e)if(rcmail.env.aformat.includes(t.name.split(".").slice(-1)[0]))filelist.push(t);else{let e="File '"+t.name+"' not allowed";console.error(e),rcmail.display_message(e,"error")}doDropUpload()}function doDropUpload(){if(filelist.length>0){let e=new FormData,t=filelist[0];filelist.shift(),e.append("dropFile",t);const n=new XMLHttpRequest;n.onload=(()=>{document.getElementById("pnlist")&&document.getElementById("pnlist").remove();const e=(new DOMParser).parseFromString(n.response,"text/html").getElementById("pnlist");document.getElementById("notes-list").appendChild(e),loader.remove(),document.querySelectorAll("#pnlist li a").forEach(function(e){e.addEventListener("click",function(){showNote(e.parentElement.id,"show")})}),cContextMenu()}),n.open("POST",location.href+"&_action=uplNote"),n.send(e)}}function cContextMenu(){if(rcmail.env.contextmenu){let e=rcmail.contextmenu.init({menu_name:"mymenu",menu_source:["#mymenu",{label:rcmail.gettext("note_show","primitivenotes"),command:"cCommand",props:"show",classes:"extwin"},{label:rcmail.gettext("note_edit","primitivenotes"),command:"cCommand",props:"edit",classes:"edit"},{label:rcmail.gettext("note_send","primitivenotes"),command:"cCommand",props:"send",classes:"send"},{label:rcmail.gettext("note_download","primitivenotes"),command:"cCommand",props:"download",classes:"download"},{label:rcmail.gettext("note_del","primitivenotes"),command:"cCommand",props:"delete",classes:"delete"}]},{beforeactivate:function(e){document.querySelectorAll("#pnlist li").forEach(function(e){e.classList.remove("lselected")}),e.source.classList.add("lselected")}});$("#pnlist li").each(function(){$(this).on("contextmenu",function(t){rcmail.contextmenu.show_one(t,this,this.id,e)})})}}function cCommand(e){let t=document.querySelector(".context-source"),n=null;switch(e){case"show":showNote(t.id,"show");break;case"edit":showNote(t.id,"edit");break;case"send":file=t.dataset.name,send_note({message:"done",name:file,type:file.slice(-3),note:""});break;case"download":downloadNote(t.dataset.name);break;case"delete":let o=document.getElementById("note_"+t.id).title;n={_file:t.dataset.name,_name:o},confirm(rcmail.gettext("note_del_note","primitivenotes").replace("%note%",o))&&rcmail.http_post("delNote",n,!1);break;default:return!1}}function downloadNote(e){let t=new XMLHttpRequest;t.onload=function(){if(200==t.status){let l=new Blob([t.response],{type:t.getResponseHeader("content-type")}),d=URL.createObjectURL(l),i=document.createElement("a");var e=t.getResponseHeader("Content-Disposition"),n=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/,o=n.exec(e);null!=o&&o[1]&&(filename=o[1].replace(/['"]/g,"")),i.href=d,i.download=filename,i.click(),setTimeout(function(){window.URL.revokeObjectURL(d)},100),loader.remove()}else{let e="Server Error! Download failed. Can't connect to server";console.error(e),rcmail.display_message(e,"error")}},t.onerror=function(){let e="Server Error! Download failed. Can't connect to server";console.error(e),rcmail.display_message(e,"error")},t.responseType="blob",t.open("GET",location.href+"&_action=getNote&_name="+e),t.send()}function sidebyside(){var e=document.querySelector('[aria-label="Save"]'),t=document.querySelector('[aria-label="Edit"]');mde.toggleSideBySide(),setTimeout(()=>{mde.isSideBySideActive()?(document.querySelector(".CodeMirror-code").classList.add("edVis"),e.classList.remove("btninv"),t.classList.add("btninv")):tPreview()},10)}function tPreview(e=""){"show"===e||"edit"===e||(e=mde.isPreviewActive()?"edit":"show"),mde.isPreviewActive()?"edit"==e&&mde.togglePreview():"show"==e&&mde.togglePreview();var t=document.querySelector('[aria-label="Save"]'),n=document.querySelector('[aria-label="Edit"]');setTimeout(()=>{"show"==e?(document.querySelector(".CodeMirror-code").classList.remove("edVis"),t.classList.add("btninv"),n.classList.remove("btninv"),document.querySelector(".preview").classList.add("active"),document.getElementById("headerTitle").classList.add("readOnly"),tagify.setReadonly(!0),document.querySelector(".tagify").classList.remove("taedit"),document.getElementById("author").readOnly=!0,document.getElementById("source").readOnly=!0,document.querySelector(".toc").classList.add("no-disable"),document.querySelector(".toc").removeAttribute("disabled"),document.querySelectorAll(".editor-preview code").forEach(function(e){e.addEventListener("click",function(){console.info("clicked");let e=this;e.classList.add("success"),navigator.clipboard.writeText(e.innerText).then(function(){setTimeout(function(){e.classList.remove("success")},1e3)},function(){console.error("Clipboard error")})})})):(document.querySelector(".CodeMirror-code").classList.add("edVis"),t.classList.remove("btninv"),n.classList.add("btninv"),document.querySelector(".preview").classList.remove("active"),document.getElementById("headerTitle").classList.remove("readOnly"),tagify.setReadonly(!1),document.querySelector(".tagify").classList.add("taedit"),document.getElementById("author").readOnly=!1,document.getElementById("source").readOnly=!1,document.querySelector(".toc").classList.remove("no-disable"),document.querySelector(".toc").setAttribute("disabled",!0),document.getElementById("tocdiv")&&document.getElementById("tocdiv").classList.remove("tocShow"))},50)}function saveFile(){document.getElementById("main_area").appendChild(loader);let e=tagify.value,t=[];for(let n in e)t.push(e[n].value);const n={_oname:document.getElementById("fname").value,_content:mde.value(),_title:document.getElementById("headerTitle").value,_author:document.getElementById("author").value,_created:document.getElementById("created").dataset.tstamp,_modified:document.getElementById("modified").value,_source:document.getElementById("source").value,_tags:t};rcmail.http_post("saveNote",n,!1)}function togglemData(){document.getElementById("ndata").classList.toggle("mtoggle")}function loadNote(e){let t=e.note.anchor?"#"+e.note.anchor:"",n=window.location.protocol+"//"+window.location.host+window.location.pathname+"?_task=notes&note="+e.note.filename+t;if(window.history.pushState({path:n},"",n),loader.remove(),screen.width<=480&&(document.getElementById("layout-list").classList.toggle("hidden"),document.getElementById("layout-content").classList.toggle("hidden")),document.getElementById("tocdiv")&&document.getElementById("tocdiv").remove(),document.getElementById("binobj")&&document.getElementById("binobj").remove(),tagify.removeAllTags(),document.getElementById("headerTitle").value=e.note.name,document.getElementById("ntags").value=e.note.tags,document.getElementById("author").value=e.note.author,document.getElementById("created").value=e.note.created,document.getElementById("created").dataset.tstamp=e.note.tstamp,document.getElementById("modified").value=e.note.modified,document.getElementById("source").value=e.note.source,document.getElementById("source").title=e.note.source,document.getElementById("fname").value=e.note.filename,document.querySelectorAll("#pnlist li").forEach(function(e){e.classList.remove("lselected")}),document.getElementById(e.note.id).classList.add("lselected"),0===e.note.mime_type.indexOf("text"))mde.value(e.note.content),document.querySelector(".EasyMDEContainer").classList.remove("mdeHide"),setTimeout(()=>{let e=document.querySelector(".CodeMirror").querySelectorAll("h1, h2, h3, h4, h5, h6"),t=document.querySelector(".toc");if(e.length>0){t.classList.add("no-disable");let n=document.createElement("div");n.id="tocdiv";let o=document.createElement("h3");o.innerText=rcmail.gettext("note_toc","primitivenotes"),n.appendChild(o);let l=document.createElement("div");l.appendChild(buildToc(tocHierarchi(tocArr(e)))),n.appendChild(l),document.querySelector(".EasyMDEContainer").appendChild(n),document.querySelectorAll("#tocdiv a").forEach(function(e){e.addEventListener("click",function(e){n.classList.toggle("tocShow")})})}else t.classList.remove("no-disable")},50),tagify.addTags(e.note.tags);else{document.querySelector(".EasyMDEContainer").classList.add("mdeHide");let t=document.createElement("div"),n=document.createElement("object");t.id="binobj",n.type=e.note.mime_type,n.data=e.note.content,n.classList.add("objcont"),t.classList.add("objdiv"),t.appendChild(n),document.getElementById("main_area").appendChild(t)}tPreview(e.mode);let o=document.querySelectorAll(".editor-preview a.intlink");o.forEach(function(e){e.addEventListener("click",function(e){if(screen.width>480){e.preventDefault(),document.querySelector(".EasyMDEContainer").classList.add("mdeHide");let t=document.createElement("div"),n=document.createElement("object");t.id="binobj",n.data=e.target.attributes.href.nodeValue,n.classList.add("objcont"),t.classList.add("objdiv"),t.appendChild(n),document.getElementById("main_area").appendChild(t)}})});let l=document.querySelectorAll(".editor-preview a.dlink");l.forEach(function(e){return e.addEventListener("click",function(e){e.preventDefault();let t=decodeURIComponent(e.target.attributes.href.value),n=t.split("#"),o=n[1].toLowerCase().replaceAll(" ","-");return showNote(document.querySelectorAll("[data-name='"+n[0]+"']")[0].id,"show",o),!1}),!1})}function buildToc(e){let n,o,l=document.createElement("ul");if(e&&e.length)for(t of e)n=document.createElement("li"),o=document.createElement("a"),o.href="#"+t.el.id,o.textContent=t.el.textContent,n.append(o),t.subitems&&t.subitems.length&&n.append(buildToc(t.subitems)),l.append(n);return l}function tocHierarchi(e){let t=Object.create(null);e.forEach(e=>t[e.idt]={...e,subitems:[]});let n=[];return e.forEach(e=>{e.parent?t[e.parent].subitems.push(t[e.idt]):n.push(t[e.idt])}),n}function tocArr(e){let t,n;for(let o=0,l=e.length;o<l;o++)if(n=e[o],n.el=n,t=parseInt(n.tagName[1],10),n.level=t,n.idt=o+1,t<=1&&(n.parent=0),o)if(e[o-1].level<t)n.parent=e[o-1].idt;else if(e[o-1].level==t)n.parent=e[o-1].parent;else for(let l=o-1;l>=0;l--)if(e[l].level==t-1){n.parent=e[l].idt;break}return e}function savedNote(e){document.getElementById("ndata").classList.remove("mtoggle"),loader.remove(),document.getElementById("notes-list").appendChild(loader);let t=["done","saved"];if(t.includes(e.message)){document.getElementById("pnlist")&&document.getElementById("pnlist").remove();const t=(new DOMParser).parseFromString(e.list,"text/html");document.getElementById("notes-list").appendChild(t.body.children[0]),document.getElementById("fname").value=e.name;let n=window.location.protocol+"//"+window.location.host+window.location.pathname+"?_task=notes&note="+document.getElementById("fname").value;window.history.pushState({path:n},"",n)}document.querySelectorAll("#pnlist li a").forEach(function(e){e.addEventListener("click",function(){showNote(e.parentElement.id,"show")})}),e.mfiles?confirm(e.mfiles.message)&&rcmail.http_post("delMedia","_media="+e.mfiles.files,!1):"saved"==e.message&&tPreview(),cContextMenu(),loader.remove()}function searchList(){let e=document.getElementById("notessearchform").value.toLowerCase().split(" "),t=document.querySelectorAll('#pnlist li:not([style*="display:none"]):not([style*="display: none"])');for(let n=0;n<t.length;n++){let o=t[n].dataset.tags.toLowerCase().split(", "),l=t[n].querySelector("a").title.toLowerCase().split(" "),d=[...new Set(o.concat(l))].join(" ");for(let o=0;o<e.length;o++)d.indexOf(e[o])>-1?t[n].style.display="":t[n].style.display="none"}}function switchDiv(){switch(document.querySelectorAll("#dldvt .tbutton").forEach(e=>{e.classList.remove("tactive")}),this.innerText){case"Extern":document.querySelector(".dldvi").style.display="none",document.querySelector(".dldve").style.display="block",this.classList.add("tactive");break;case"Intern":document.querySelector(".dldvi").style.display="block",document.querySelector(".dldve").style.display="none",this.classList.add("tactive");break;default:document.getElementById("modal").style.visibility="hidden",document.querySelector("#flink .hshow")&&document.querySelector("#flink .hshow").classList.remove("hshow")}}function linkURL(){document.querySelector("#dldvt span").classList.add("tactive");let e=document.getElementById("lsearch"),t=mde.codemirror.getSelection().trim();document.getElementById("lselection").value=t,e.value=t,t=t.length>0?t:"unknown";let n="["+t+"]()",o=document.getElementById("modal");document.querySelector("#flink .text").innerText=n,o.style.visibility="visible",linkSearch(),e.addEventListener("keyup",linkSearch)}function linkSearch(){filter=document.getElementById("lsearch").value.toUpperCase();let e=document.getElementById("pnlist").cloneNode(!0),t=e.getElementsByTagName("li");for(document.getElementById("dlist")&&document.getElementById("dlist").remove(),document.getElementById("headinglist")&&document.getElementById("headinglist").remove(),dlist=document.createElement("ul"),dlist.id="dlist",i=0;i<t.length;i++)dlistTags=t[i].dataset.tags,dlistNames=t[i].dataset.name,(dlistTags.toUpperCase().indexOf(filter)>-1||dlistNames.toUpperCase().indexOf(filter)>-1)&&(t[i].addEventListener("click",function(e){let t=document.getElementById("lselection").value;document.getElementById("lfile").value=this.dataset.name;let n="["+t+"]("+encodeURIComponent(document.getElementById("lfile").value)+")";document.querySelector("#flink .text").innerText=n,postData={_name:document.getElementById("lfile").value},rcmail.http_post("cHeadings",postData,!1)}),dlist.appendChild(t[i]));let n=document.getElementById("dldvn");dlist.children.length>0&&(n.appendChild(dlist),document.querySelector("#dlist .lselected")&&document.querySelector("#dlist .lselected").classList.remove("lselected"))}function getHeadings(e){if("ok"==e.message)if(e.count>0){document.querySelector("#flink .headings").classList.add("hshow"),document.getElementById("headinglist")&&document.getElementById("headinglist").remove();let t=document.createElement("ul");t.id="headinglist",e.headings.forEach(e=>{let n=document.createElement("li"),o=e[0],l=parseInt(e[1].substring(1));o=o.substring(l).trim(),n.innerHTML=o+"<span>"+e[1]+"</span>",n.addEventListener("click",e=>{document.getElementById("lheading").value=e.target.innerText.split("\n")[0];let t="["+document.getElementById("lselection").value+"]("+encodeURIComponent(document.getElementById("lfile").value)+"#"+encodeURIComponent(document.getElementById("lheading").value)+")";document.querySelector("#flink .text").innerText=t,document.getElementById("headinglist")&&document.getElementById("headinglist").remove(),document.getElementById("dlist").classList.remove("dlh")}),t.appendChild(n)}),document.body.appendChild(t)}else document.querySelector("#flink .headings").classList.remove("hshow"),console.warn("No headings found");else console.warn(e.message)}function showHeadings(){let e=document.getElementById("dldvn");document.getElementById("dlist").classList.add("dlh");let t=document.getElementById("headinglist");e.appendChild(t)}function toggleTOC(){let e=document.getElementById("tocdiv");e&&e.classList.toggle("tocShow")}function showNote(e,t="show",n=""){let o;document.getElementById("ndata").classList.remove("mtoggle");let l=["md","txt","html","jpg"],d=document.getElementById(e).dataset.format;screen.width>480||-1!=l.indexOf(d)?(document.getElementById("main_area").appendChild(loader),o={_name:document.getElementById(e).dataset.name,_id:e,_mode:t,_anchor:n},rcmail.http_post("displayNote",o,!1)):downloadNote(document.getElementById(e).dataset.name)}function pnoptions(){location.href=window.location.origin+window.location.pathname+"?_task=settings&_action=preferences#pnotes"}function send_note(e){rcmail.goto_url("mail/compose",{_note_filename:e.name},!0)}function new_note(e){screen.width<=480&&(document.getElementById("layout-list").classList.toggle("hidden"),document.getElementById("layout-content").classList.toggle("hidden")),document.title=rcmail.env.nnote;let t=window.location.protocol+"//"+window.location.host+window.location.pathname+"?_task=notes";window.history.pushState({path:t},"",t),document.getElementById("headerTitle").placeholder=rcmail.gettext("note_title","primitivenotes"),document.querySelector(".tagify__input").dataset.placeholder="Tags",format=e||rcmail.env.dformat,mde.value(""),tPreview("edit"),document.getElementById("headerTitle").value="",document.getElementById("headerTitle").classList.remove("readOnly"),tagify.removeAllTags(),tagify.setReadonly(!1),document.querySelector(".tagify").classList.add("taedit"),document.getElementById("author").readOnly=!1,document.getElementById("author").value="",document.getElementById("source").readOnly=!1,document.getElementById("source").value="",document.getElementById("created").value="",document.getElementById("modified").value="",document.getElementById("fname").value="",document.querySelector(".toc").classList.remove("no-disable"),document.querySelector(".toc").setAttribute("disabled",!0),document.getElementById("tocdiv")&&document.getElementById("tocdiv").classList.remove("tocShow")}function add_note(){document.getElementById("upl").click()}function mform(){document.getElementById("main_area").appendChild(loader),fileName=this.value;let e=["pdf","jpg","jpeg","png"];if(e.includes(fileName.split(".").pop().toLowerCase())){let e=new FormData;e.append("dropFile",document.getElementById("dropMedia").files[0]);var t=new XMLHttpRequest;t.onload=(()=>{mde.codemirror.replaceSelection(t.responseText),loader.remove()}),t.open("POST",location.href+"&_action=uplMedia"),t.send(e)}else alert(rcmail.gettext("note_inv_format","primitivenotes"));return!1}function sform(){fileName=this.value;let e=fileName.split(".").pop().toLowerCase();if(rcmail.env.aformat.includes(e)){let e=new FormData(document.getElementById("upl_form"));const t=new XMLHttpRequest;t.onload=(()=>{document.getElementById("pnlist")&&document.getElementById("pnlist").remove();const e=(new DOMParser).parseFromString(t.response,"text/html").getElementById("pnlist");document.getElementById("notes-list").appendChild(e),loader.remove(),document.querySelectorAll("#pnlist li a").forEach(function(e){e.addEventListener("click",function(){showNote(e.parentElement.id,"show")})}),cContextMenu()}),t.open("POST",location.href+"&_action=uplNote"),t.send(e)}else alert(rcmail.gettext("note_inv_format","primitivenotes"));return!1}var mde,tagify,originalData,filelist=[],loader=document.createElement("div"),ldr=document.createElement("div");ldr.classList.add("db-spinner"),loader.classList.add("lbg"),loader.appendChild(ldr),window.rcmail&&rcmail.addEventListener("init",function(e){"notes"===new URLSearchParams(window.location.search).get("_task")?document.querySelector(".task-menu-button")&&document.querySelector(".task-menu-button").classList.add("notes"):document.querySelector(".task-menu-button")&&document.querySelector(".task-menu-button").classList.remove("notes"),document.getElementById("headerTitle").placeholder=rcmail.gettext("note_title","primitivenotes"),document.querySelector(".back-list-button")&&(document.getElementById("headerTitle").style.width="block"==window.getComputedStyle(document.querySelector(".back-list-button"),null).display?document.getElementById("headerTitle").style.width="calc(100% - 30px)":document.getElementById("headerTitle").style.width="calc(100% - 10px)"),mde=new EasyMDE({element:document.getElementById("editor1"),autoDownloadFontAwesome:!1,autofocus:!0,previewImagesInEditor:!1,spellChecker:!1,promptURLs:!0,inputStyle:"contenteditable",nativeSpellcheck:!0,forceSync:!1,sideBySideFullscreen:!1,iconsSet:"material",toolbar:[{name:"edit",action:tPreview,title:"Edit",className:"btninv fa fa-pen no-disable"},{name:"save",action:saveFile,title:"Save",className:"fa fa-floppy-disk no-disable"},{name:"side-by-side",action:sidebyside,title:"Toggle Side by Side",className:"side-by-side fa fa-columns no-disable"},"|","bold","italic","heading","clean-block","|","quote","code","unordered-list","ordered-list","|",{name:"linkURL",action:linkURL,title:"Create Link",className:"fa fa-link"},{name:"media",action:uplMedia,title:"Insert Media",className:"fa fa-image"},"table","|",{name:"preview",action:tPreview,title:"Toggle Preview",className:"preview fa fa-eye no-disable"},{name:"meta",action:togglemData,className:"fa fa-lightbulb no-disable",title:"Metadata"},{name:"toc",action:toggleTOC,className:"fa fa-list-alt",title:"TOC",attributes:{disabled:"",id:"test"}}],shortcuts:{save:"Ctrl-S",edit:"Ctrl-E","side-by-side":"F9"},renderingConfig:{codeSyntaxHighlighting:!0,sanitizerFunction:function(e){let t=e.replaceAll(rcmail.env.mfolder+"/","?_task=notes&_action=blink&_file=");return t=t.replaceAll('a href="?_task','a class="intlink" href="?_task'),t=t.replaceAll('a href="http','a class="extlink" href="http'),t=t.replaceAll('a href="','a class="dlink" href="'),t=t.replaceAll("<pre>",'<pre class="hljs">'),document.querySelectorAll(".intlink").forEach(function(e){e.addEventListener("click",function(){showNote(119)})}),t}}});let t=null!=rcmail.env.taglist?JSON.parse(rcmail.env.taglist):[];if(tagify=new Tagify(document.getElementById("ntags"),{whitelist:t,dropdown:{classname:"color-blue",trim:!0,enabled:0,maxItems:t.length,position:"text",closeOnSelect:!1,highlightFirst:!0},trim:!0,duplicates:!1,enforceWhitelist:!1,delimiters:",|;| "}),document.getElementById("notessearchform").addEventListener("input",searchList,!1),document.querySelectorAll("#pnlist li a").forEach(function(e){e.addEventListener("click",function(){showNote(e.parentElement.id,"show")})}),rcmail.addEventListener("plugin.loadNote",loadNote),rcmail.addEventListener("plugin.savedNote",savedNote),rcmail.addEventListener("plugin.getNote",downloadNote),rcmail.addEventListener("plugin.getHeadings",getHeadings),cContextMenu(),rcmail.register_command("cCommand",cCommand,!0),rcmail.register_command("addnote",add_note,!0),rcmail.register_command("newnote",new_note,!0),rcmail.register_command("pnoptions",pnoptions,!0),document.getElementById("upl")&&document.getElementById("upl").addEventListener("change",sform,!1),document.getElementById("dropMedia")&&document.getElementById("dropMedia").addEventListener("change",mform,!1),"#pnotes"==window.location.hash&&rcmail.sections_list.select_row("primitivenotes"),document.getElementById("notes-list")){var n=!1;document.getElementById("notes-list").addEventListener("dragenter",function(e){e.preventDefault(),e.stopPropagation(),n=!0,setTimeout(function(){n=!1},1),document.getElementById("notes-list").classList.add("highlight")}),document.getElementById("notes-list").addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),!1===n&&document.getElementById("notes-list").classList.remove("highlight")}),document.getElementById("notes-list").addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()}),document.getElementById("notes-list").addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),document.getElementById("notes-list").classList.remove("highlight"),manageDropUpload(e.dataTransfer.files)})}window.addEventListener("keydown",function(e){if(e.shiftKey&&e.ctrlKey&&"KeyF"===e.code)return document.getElementById("notessearchform").focus(),!1}),window.addEventListener("beforeprint",e=>{document.body.innerHTML='<html><head><link rel="stylesheet" type="text/css" href="plugins/primitivenotes/skins/print.css"></link><link rel="stylesheet" type="text/css" href="plugins/primitivenotes/js/highlight/styles/default.css"></link><title>'+document.getElementById("headerTitle").value+"</title></head><body>"+mde.markdown(mde.value())+"</body>",window.onfocus=function(){location.reload()}}),document.getElementById("notessearchform").addEventListener("keydown",e=>{"Backspace"!==e.key&&"Delete"!==e.key||document.querySelectorAll("#pnlist li").forEach(e=>{e.style.display=""})}),document.getElementById("notessearchform").addEventListener("search",e=>{""==document.getElementById("notessearchform").value?document.querySelectorAll("#pnlist li").forEach(e=>{e.style.display=""}):searchList()}),document.addEventListener("keyup",e=>{"Escape"==e.key&&(!1===mde.isPreviewActive()&&document.getElementById("notessearchform")!==document.activeElement&&""!==mde.value()&&tPreview("show"),document.getElementById("notessearchform")===document.activeElement&&(document.getElementById("notessearchform").value="",document.querySelectorAll("#pnlist li").forEach(e=>{e.style.display=""})))}),document.getElementById("source").addEventListener("click",osource,!0),document.querySelector(".EasyMDEContainer").addEventListener("paste",pasteParse,!0);let o=new URLSearchParams(document.location.search).get("note");if(o){let e=null;document.querySelectorAll("#pnlist li").forEach((t,n,l)=>{t.dataset.name==o&&(e=t.id,l.length=n+1)});let t={_name:o,_id:e,_mode:"show"};rcmail.http_post("displayNote",t,!1)}document.getElementById("cdlist").addEventListener("click",function(){document.getElementById("modal").style.visibility="hidden"}),document.getElementById("odlist").addEventListener("click",function(){mde.codemirror.replaceSelection(document.querySelector("#flink .text").innerText),document.getElementById("modal").style.visibility="hidden"}),document.getElementById("lurl").addEventListener("input",function(){let e=document.querySelector("#flink .text"),t="["+mde.codemirror.getSelection().trim()+"]("+document.getElementById("lurl").value+")";e.innerText=t,e.title=e.innerText}),document.querySelectorAll("#dldvt .tbutton").forEach(e=>{e.addEventListener("click",switchDiv)}),document.querySelector("#flink .headings").addEventListener("click",showHeadings)});